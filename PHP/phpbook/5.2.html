<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5.2 编译我们的扩展 | Bing</title>
    <meta name="description" content="文档空间">
    <link rel="icon" href="https://avatars.githubusercontent.com/bingbig">
    
    <link rel="preload" href="/assets/css/0.styles.16105da8.css" as="style"><link rel="preload" href="/assets/js/app.6b2c809f.js" as="script"><link rel="preload" href="/assets/js/162.6285f306.js" as="script"><link rel="prefetch" href="/assets/js/10.f6176989.js"><link rel="prefetch" href="/assets/js/100.0768a1d7.js"><link rel="prefetch" href="/assets/js/101.ec9cf3e3.js"><link rel="prefetch" href="/assets/js/102.66ac4896.js"><link rel="prefetch" href="/assets/js/103.401d4b10.js"><link rel="prefetch" href="/assets/js/104.b2f962d3.js"><link rel="prefetch" href="/assets/js/105.9f9dc167.js"><link rel="prefetch" href="/assets/js/106.d22423d9.js"><link rel="prefetch" href="/assets/js/107.b627322d.js"><link rel="prefetch" href="/assets/js/108.52af3356.js"><link rel="prefetch" href="/assets/js/109.f12ba199.js"><link rel="prefetch" href="/assets/js/11.647dbc36.js"><link rel="prefetch" href="/assets/js/110.a2a4e6cb.js"><link rel="prefetch" href="/assets/js/111.94c3aaaa.js"><link rel="prefetch" href="/assets/js/112.8aea190a.js"><link rel="prefetch" href="/assets/js/113.1a7ccce8.js"><link rel="prefetch" href="/assets/js/114.db890620.js"><link rel="prefetch" href="/assets/js/115.84b8a260.js"><link rel="prefetch" href="/assets/js/116.7d5268cf.js"><link rel="prefetch" href="/assets/js/117.93c01afe.js"><link rel="prefetch" href="/assets/js/118.b25aa971.js"><link rel="prefetch" href="/assets/js/119.fa014286.js"><link rel="prefetch" href="/assets/js/12.84989b4b.js"><link rel="prefetch" href="/assets/js/120.3693ed0b.js"><link rel="prefetch" href="/assets/js/121.5c0f9771.js"><link rel="prefetch" href="/assets/js/122.109848a6.js"><link rel="prefetch" href="/assets/js/123.b8ee4cff.js"><link rel="prefetch" href="/assets/js/124.552dbc17.js"><link rel="prefetch" href="/assets/js/125.883a4e39.js"><link rel="prefetch" href="/assets/js/126.d89b69d2.js"><link rel="prefetch" href="/assets/js/127.c25e84b0.js"><link rel="prefetch" href="/assets/js/128.a452bcc0.js"><link rel="prefetch" href="/assets/js/129.5901a6f1.js"><link rel="prefetch" href="/assets/js/13.e9d34bfe.js"><link rel="prefetch" href="/assets/js/130.b4288184.js"><link rel="prefetch" href="/assets/js/131.bedcaf9c.js"><link rel="prefetch" href="/assets/js/132.5d4a9fa7.js"><link rel="prefetch" href="/assets/js/133.0e8935ab.js"><link rel="prefetch" href="/assets/js/134.51191e5b.js"><link rel="prefetch" href="/assets/js/135.52fc1365.js"><link rel="prefetch" href="/assets/js/136.12ce5b0c.js"><link rel="prefetch" href="/assets/js/137.bcd4b6f9.js"><link rel="prefetch" href="/assets/js/138.ceba826f.js"><link rel="prefetch" href="/assets/js/139.ab41ed03.js"><link rel="prefetch" href="/assets/js/14.bba95746.js"><link rel="prefetch" href="/assets/js/140.9195afbf.js"><link rel="prefetch" href="/assets/js/141.52de6632.js"><link rel="prefetch" href="/assets/js/142.5991a8c3.js"><link rel="prefetch" href="/assets/js/143.2eb890d2.js"><link rel="prefetch" href="/assets/js/144.d5731614.js"><link rel="prefetch" href="/assets/js/145.9ff0d3f7.js"><link rel="prefetch" href="/assets/js/146.62553ebb.js"><link rel="prefetch" href="/assets/js/147.5bb534ce.js"><link rel="prefetch" href="/assets/js/148.cfdcb4b2.js"><link rel="prefetch" href="/assets/js/149.ffb0f335.js"><link rel="prefetch" href="/assets/js/15.abdbf40e.js"><link rel="prefetch" href="/assets/js/150.3fa2add3.js"><link rel="prefetch" href="/assets/js/151.d9de380a.js"><link rel="prefetch" href="/assets/js/152.8820d383.js"><link rel="prefetch" href="/assets/js/153.1a7deb16.js"><link rel="prefetch" href="/assets/js/154.8a8d04d5.js"><link rel="prefetch" href="/assets/js/155.e596bd6e.js"><link rel="prefetch" href="/assets/js/156.f93ffc96.js"><link rel="prefetch" href="/assets/js/157.1d4e442a.js"><link rel="prefetch" href="/assets/js/158.5bfb982e.js"><link rel="prefetch" href="/assets/js/159.bbdebf53.js"><link rel="prefetch" href="/assets/js/16.23a09bd0.js"><link rel="prefetch" href="/assets/js/160.c5eae96d.js"><link rel="prefetch" href="/assets/js/161.a2241d1a.js"><link rel="prefetch" href="/assets/js/163.7e424328.js"><link rel="prefetch" href="/assets/js/164.250fa087.js"><link rel="prefetch" href="/assets/js/165.6cf851be.js"><link rel="prefetch" href="/assets/js/166.17548140.js"><link rel="prefetch" href="/assets/js/167.81a169ac.js"><link rel="prefetch" href="/assets/js/168.21634c85.js"><link rel="prefetch" href="/assets/js/169.5cb2c187.js"><link rel="prefetch" href="/assets/js/17.26a3f651.js"><link rel="prefetch" href="/assets/js/170.842ec593.js"><link rel="prefetch" href="/assets/js/171.5fe1f306.js"><link rel="prefetch" href="/assets/js/172.57d63125.js"><link rel="prefetch" href="/assets/js/173.17e0e721.js"><link rel="prefetch" href="/assets/js/174.cd1048c8.js"><link rel="prefetch" href="/assets/js/175.2a9ed138.js"><link rel="prefetch" href="/assets/js/176.63b2df6e.js"><link rel="prefetch" href="/assets/js/177.ab26fd53.js"><link rel="prefetch" href="/assets/js/178.f2760c4a.js"><link rel="prefetch" href="/assets/js/179.581bbced.js"><link rel="prefetch" href="/assets/js/18.34749364.js"><link rel="prefetch" href="/assets/js/180.b390c5bb.js"><link rel="prefetch" href="/assets/js/181.385f7953.js"><link rel="prefetch" href="/assets/js/182.6cfb5179.js"><link rel="prefetch" href="/assets/js/183.4418d89d.js"><link rel="prefetch" href="/assets/js/184.f62d568a.js"><link rel="prefetch" href="/assets/js/185.652389ca.js"><link rel="prefetch" href="/assets/js/186.a15b5381.js"><link rel="prefetch" href="/assets/js/187.7e93ef83.js"><link rel="prefetch" href="/assets/js/188.188b9aa4.js"><link rel="prefetch" href="/assets/js/189.58d2adc8.js"><link rel="prefetch" href="/assets/js/19.33b6e0d9.js"><link rel="prefetch" href="/assets/js/190.f31d04b6.js"><link rel="prefetch" href="/assets/js/191.497232ef.js"><link rel="prefetch" href="/assets/js/192.a2045cfc.js"><link rel="prefetch" href="/assets/js/193.b430b41f.js"><link rel="prefetch" href="/assets/js/194.33a6fd3b.js"><link rel="prefetch" href="/assets/js/195.82574543.js"><link rel="prefetch" href="/assets/js/196.27161d59.js"><link rel="prefetch" href="/assets/js/197.e546d765.js"><link rel="prefetch" href="/assets/js/198.a3dc4687.js"><link rel="prefetch" href="/assets/js/199.7e1730f0.js"><link rel="prefetch" href="/assets/js/2.c4c7f0aa.js"><link rel="prefetch" href="/assets/js/20.be43276b.js"><link rel="prefetch" href="/assets/js/200.0ebceee7.js"><link rel="prefetch" href="/assets/js/201.ffa9096a.js"><link rel="prefetch" href="/assets/js/202.dea9f407.js"><link rel="prefetch" href="/assets/js/203.65f71b7b.js"><link rel="prefetch" href="/assets/js/204.6eccc640.js"><link rel="prefetch" href="/assets/js/205.37e32653.js"><link rel="prefetch" href="/assets/js/206.770c36ba.js"><link rel="prefetch" href="/assets/js/207.9cab62e1.js"><link rel="prefetch" href="/assets/js/208.e7eccf84.js"><link rel="prefetch" href="/assets/js/209.ce1441e1.js"><link rel="prefetch" href="/assets/js/21.7db2670e.js"><link rel="prefetch" href="/assets/js/210.e5a10df7.js"><link rel="prefetch" href="/assets/js/211.06c60da9.js"><link rel="prefetch" href="/assets/js/212.bf6984bf.js"><link rel="prefetch" href="/assets/js/213.c22eb113.js"><link rel="prefetch" href="/assets/js/214.3aab7d1f.js"><link rel="prefetch" href="/assets/js/215.5b082314.js"><link rel="prefetch" href="/assets/js/216.340588a3.js"><link rel="prefetch" href="/assets/js/217.9b3c8940.js"><link rel="prefetch" href="/assets/js/218.c38d9710.js"><link rel="prefetch" href="/assets/js/219.f21e2c60.js"><link rel="prefetch" href="/assets/js/22.e10869f6.js"><link rel="prefetch" href="/assets/js/220.38b3038d.js"><link rel="prefetch" href="/assets/js/221.ba426e65.js"><link rel="prefetch" href="/assets/js/222.265c024f.js"><link rel="prefetch" href="/assets/js/223.66962a7a.js"><link rel="prefetch" href="/assets/js/224.96713221.js"><link rel="prefetch" href="/assets/js/225.8915aaa4.js"><link rel="prefetch" href="/assets/js/226.6b285af0.js"><link rel="prefetch" href="/assets/js/227.b47d9853.js"><link rel="prefetch" href="/assets/js/228.9f6cbae9.js"><link rel="prefetch" href="/assets/js/23.1090bcef.js"><link rel="prefetch" href="/assets/js/24.42ca9d60.js"><link rel="prefetch" href="/assets/js/25.51778f79.js"><link rel="prefetch" href="/assets/js/26.fd01a47c.js"><link rel="prefetch" href="/assets/js/27.dacd7ea5.js"><link rel="prefetch" href="/assets/js/28.463ba231.js"><link rel="prefetch" href="/assets/js/29.ac24f130.js"><link rel="prefetch" href="/assets/js/3.803cd987.js"><link rel="prefetch" href="/assets/js/30.5fa4570d.js"><link rel="prefetch" href="/assets/js/31.8b53ab8a.js"><link rel="prefetch" href="/assets/js/32.2b71f979.js"><link rel="prefetch" href="/assets/js/33.377c2bbd.js"><link rel="prefetch" href="/assets/js/34.aa0b55c3.js"><link rel="prefetch" href="/assets/js/35.841f5ce9.js"><link rel="prefetch" href="/assets/js/36.b3151090.js"><link rel="prefetch" href="/assets/js/37.dd466b10.js"><link rel="prefetch" href="/assets/js/38.7631230b.js"><link rel="prefetch" href="/assets/js/39.bdbd4150.js"><link rel="prefetch" href="/assets/js/4.f376888f.js"><link rel="prefetch" href="/assets/js/40.bd0aba4d.js"><link rel="prefetch" href="/assets/js/41.fb240faa.js"><link rel="prefetch" href="/assets/js/42.573f42b6.js"><link rel="prefetch" href="/assets/js/43.f3ab36d0.js"><link rel="prefetch" href="/assets/js/44.d72fbc07.js"><link rel="prefetch" href="/assets/js/45.a2c94371.js"><link rel="prefetch" href="/assets/js/46.e22c3a4d.js"><link rel="prefetch" href="/assets/js/47.699bd039.js"><link rel="prefetch" href="/assets/js/48.643e09ec.js"><link rel="prefetch" href="/assets/js/49.5593dccf.js"><link rel="prefetch" href="/assets/js/5.aa717142.js"><link rel="prefetch" href="/assets/js/50.bfb98f44.js"><link rel="prefetch" href="/assets/js/51.bb668b1f.js"><link rel="prefetch" href="/assets/js/52.a1e166b8.js"><link rel="prefetch" href="/assets/js/53.d9d4ab66.js"><link rel="prefetch" href="/assets/js/54.365f1440.js"><link rel="prefetch" href="/assets/js/55.aa7a99bc.js"><link rel="prefetch" href="/assets/js/56.f71d3bdc.js"><link rel="prefetch" href="/assets/js/57.c22489ff.js"><link rel="prefetch" href="/assets/js/58.961cb551.js"><link rel="prefetch" href="/assets/js/59.625c571b.js"><link rel="prefetch" href="/assets/js/6.2c0dbfe9.js"><link rel="prefetch" href="/assets/js/60.7cad7d61.js"><link rel="prefetch" href="/assets/js/61.3ab2039b.js"><link rel="prefetch" href="/assets/js/62.ebbcc7a8.js"><link rel="prefetch" href="/assets/js/63.022f6fe1.js"><link rel="prefetch" href="/assets/js/64.cfc0dcb3.js"><link rel="prefetch" href="/assets/js/65.4f892233.js"><link rel="prefetch" href="/assets/js/66.6e6574c2.js"><link rel="prefetch" href="/assets/js/67.40fb186e.js"><link rel="prefetch" href="/assets/js/68.54858ca7.js"><link rel="prefetch" href="/assets/js/69.e028e80f.js"><link rel="prefetch" href="/assets/js/7.3d66d209.js"><link rel="prefetch" href="/assets/js/70.9c1a0d51.js"><link rel="prefetch" href="/assets/js/71.9e6467f5.js"><link rel="prefetch" href="/assets/js/72.60bfce27.js"><link rel="prefetch" href="/assets/js/73.9ec43056.js"><link rel="prefetch" href="/assets/js/74.0aa6072f.js"><link rel="prefetch" href="/assets/js/75.865d7dda.js"><link rel="prefetch" href="/assets/js/76.fc1f0140.js"><link rel="prefetch" href="/assets/js/77.51e20bb9.js"><link rel="prefetch" href="/assets/js/78.93dbf54e.js"><link rel="prefetch" href="/assets/js/79.7a5b89c7.js"><link rel="prefetch" href="/assets/js/8.5b98a3a4.js"><link rel="prefetch" href="/assets/js/80.d2e23095.js"><link rel="prefetch" href="/assets/js/81.8b16c2f7.js"><link rel="prefetch" href="/assets/js/82.db077248.js"><link rel="prefetch" href="/assets/js/83.360d0cb4.js"><link rel="prefetch" href="/assets/js/84.50dadff3.js"><link rel="prefetch" href="/assets/js/85.0111e9a1.js"><link rel="prefetch" href="/assets/js/86.b2425a36.js"><link rel="prefetch" href="/assets/js/87.63aebc19.js"><link rel="prefetch" href="/assets/js/88.479041f7.js"><link rel="prefetch" href="/assets/js/89.769c409d.js"><link rel="prefetch" href="/assets/js/9.520db884.js"><link rel="prefetch" href="/assets/js/90.2ec7b507.js"><link rel="prefetch" href="/assets/js/91.9cae6dae.js"><link rel="prefetch" href="/assets/js/92.7863085a.js"><link rel="prefetch" href="/assets/js/93.3023daa8.js"><link rel="prefetch" href="/assets/js/94.7ffa85cb.js"><link rel="prefetch" href="/assets/js/95.b8b1e5dc.js"><link rel="prefetch" href="/assets/js/96.79ba50a3.js"><link rel="prefetch" href="/assets/js/97.988cb9bc.js"><link rel="prefetch" href="/assets/js/98.95938b5a.js"><link rel="prefetch" href="/assets/js/99.4842d35c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16105da8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bing</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/PHP/content.html" class="sidebar-link">PHP</a></li><li><a href="/PHP/basic.html" class="sidebar-link">PHP基础知识</a></li><li><a href="/PHP/tips.html" class="sidebar-link">PHP编程技巧与优化</a></li><li><a href="/PHP/sugs.html" class="sidebar-link">PHP 安全编程建议</a></li><li><a href="/PHP/static.html" class="sidebar-link">Static</a></li><li><a href="/PHP/router.html" class="sidebar-link">PHP路由技术的原理与实践</a></li><li><a href="/PHP/composer.html" class="sidebar-link">Composer</a></li><li><a href="/PHP/OOP/SRP.html" class="sidebar-link">单一职责原则SRP</a></li><li><a href="/PHP/OOP/OCP.html" class="sidebar-link">开闭原则OCP</a></li><li><a href="/PHP/OOP/LSP.html" class="sidebar-link">里氏替换原则LSP</a></li><li><a href="/PHP/OOP/ISP.html" class="sidebar-link">接口隔离原则ISP</a></li><li><a href="/PHP/OOP/DIP.html" class="sidebar-link">依赖倒置原则DIP</a></li><li><a href="/PHP/OOP/abstract_class.html" class="sidebar-link">抽象类</a></li><li><a href="/PHP/Laravel/Container.html" class="sidebar-link">Laravel 源码阅读 －容器</a></li><li><a href="/PHP/pattern/singleton.html" class="sidebar-link">单例模式</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="_5-2-编译我们的扩展"><a href="#_5-2-编译我们的扩展" aria-hidden="true" class="header-anchor">#</a> 5.2 编译我们的扩展</h1> <p>我们已经在上一节准备好了需要编译的源文件，接下来需要的便是把它们编译成目标文件了。因为在*nix平台和win平台下的编译步骤有些差异，所以这个地方需要分成两块介绍，很不幸，win部分还没有整理，请随时关注本项目。</p> <h3 id="在-nix下编译"><a href="#在-nix下编译" aria-hidden="true" class="header-anchor">#</a> 在*nix下编译</h3> <p>第一步：我们需要根据config.m4文件生成一个configure脚本、Makefile等文件，这一步有phpize来帮我们做：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>$ phpize
PHP Api Version<span class="token punctuation">:</span> <span class="token number">20041225</span>
Zend Module Api No<span class="token punctuation">:</span> <span class="token number">20050617</span>
Zend Extension Api No<span class="token punctuation">:</span> <span class="token number">220050617</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The extra 2 at the start of Zend Extension Api No isn't a typo; it corresponds to the Zend Engine 2 version and is meant to keep this API number greater than its ZE1 counterpart.</p> <p>现在查看一下我们扩展所在的目录，会发现多了许多文件。phpize程序根据config.m4里的信息生成了许多编译php扩展必须的文件，比如生成makefiles等，这为我们省了很多的麻烦。 接下来我们运行./configure脚本，这里我们并不需要再注明enable-maintainer-zts、enable-debug等参数，phpize程序会自动的去已经编译完成的php核心里获取这几个参数的值。 接下来就像我们安装其它程序一样执行make; make test;即可，如果没有错误，那么在module文件夹下面便会生成我们的目标文件 —— walu.so。</p> <h3 id="在windows平台下编译"><a href="#在windows平台下编译" aria-hidden="true" class="header-anchor">#</a> 在windows平台下编译</h3> <p>The config.m4 file you created earlier was actually specific to the *nix build. In order to make your extension compile under Windows, you'll need to create a separatebut similarconfiguration file for it.
Add config.w32 with the following contents to your ext/sample directory:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ARG_ENABLE</span><span class="token punctuation">(</span><span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enable sample extension&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>PHP_SAMPLE <span class="token operator">!=</span> <span class="token string">&quot;no&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">EXTENSION</span><span class="token punctuation">(</span><span class="token string">&quot;sample&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sample.c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>As you can see, this file bears a resemblance on a high level to config.m4. The option is declared, tested, and conditionally used to enable the build of your extension.
Now you'll repeat a few of the steps you performed in Chapter 4, &quot;Setting Up a Build Environment,&quot; when you built the PHP core. Start by opening up a build window from the Start menu by selecting All Programs, Microsoft Platform SDK for Windows Server 2003 SP1, Open Build Environment Window, Windows 2000 Build Environment, Set Windows 2000 Build Environment (Debug), and running the C:\Program Files\Microsoft Visual Studio 8\VC\bin\vcvars32.bat batch file.
Remember, your installation might require you to select a different build target or run a slightly different batch file. Refer to the notes in the corresponding section of Chapter 4 to refresh your memory.
Again, you'll want to go to the root of your build directory and rebuild the configure script.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>C<span class="token punctuation">:</span>\Program Files\Microsoft Platform SDK<span class="token operator">&gt;</span> cd \PHPDEV\php<span class="token operator">-</span><span class="token number">5.1</span><span class="token number">.0</span>
C<span class="token punctuation">:</span>\PHPDEV\php<span class="token operator">-</span><span class="token number">5.1</span><span class="token number">.0</span><span class="token operator">&gt;</span> buildconf<span class="token punctuation">.</span>bat
Rebuilding configure<span class="token punctuation">.</span>js
Now run <span class="token string">'cscript /nologo configure.js help'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>This time, you'll run the configure script with an abridged set of options. Because you'll be focusing on just your extension and not the whole of PHP, you can leave out options pertaining to other extensions; however, unlike the Unix build, you do need to include the enable-debug switch explicitly even though the core build already has it.
The only crucial switch you'll need hereapart from debug of courseis enable-sample=shared. The shared option is required here because configure.js doesn't know that you're planning to build sample as a loadable extension. Your configure line should therefore look something like this:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>C<span class="token punctuation">:</span>\PHPDEV\php<span class="token operator">-</span><span class="token number">5.1</span><span class="token number">.0</span><span class="token operator">&gt;</span> cscript <span class="token operator">/</span>nologo configure<span class="token punctuation">.</span>js \
enable<span class="token operator">-</span>debug enable<span class="token operator">-</span>sample<span class="token operator">=</span>shared

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Recall that enable-maintainer-zts is not required here as all Win32 builds assume that ZTS must be enabled. Options relating to SAPIssuch as embedare also not required here as the SAPI layer is independent from the extension layer.</p> <p>Lastly, you're ready to build the extension. Because this build is based from the coreunlike the Unix extension build, which was based from the extensionyou'll need to specify the target name in your build line.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>C<span class="token punctuation">:</span>\PHPDEV\php<span class="token operator">-</span><span class="token number">5.1</span><span class="token number">.0</span><span class="token operator">&gt;</span> nmake php_sample<span class="token punctuation">.</span>dll
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once compilation is complete, you should have a working php_sample.dll binary ready to be used in the next step. Remember, because this book focuses on *nix development, the extension will be referred to as sample.so rather than php_sample.dll in all following text.
Loading an Extension Built as a Shared Module</p> <h3 id="加载扩展"><a href="#加载扩展" aria-hidden="true" class="header-anchor">#</a> 加载扩展</h3> <p>为了使PHP能够找到需要的扩展文件，我们需要把编译好的so文件或者dll文件复制到PHP的扩展目录下，它的地址我们可以通过phpinfo()输出的信息找到，也可以在php.ini文件里进行配置找到并配置，名称为：extension_dir的值。默认情况下，php.ini文件位于/usr/local/lib/php.ini或者C:\windows\php.ini(现在由于fastcgi模式居多，在win平台上php.ini越来越多的直接存在于php-cgi.exe程序所在目录下)。如果找不到，我们可以通过php -i 命令或者&lt;?php phpinfo();来查看当前加载的php.ini文件位置。
一旦我们设置了extension_dir，便可以在我们的web文件中引用我们的扩展了，我们可以通过dl命令来将我们的扩展加载到内存中来。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">dl</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'sample.so'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">get_loaded_extensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果在输出中我们没有找到walu.so，那肯定是哪里出问题了。这时候我们需要根据程序的输出信息去查找错误。
上面这样每次使用扩展都需要先dl一下真是太麻烦了，其实我们有更好的办法让php运行时自动加载我们的扩展。那就是在php.ini里这样配置：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>extension_dir<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>lib<span class="token operator">/</span>php<span class="token operator">/</span>modules<span class="token operator">/</span>
extension<span class="token operator">=</span>walu<span class="token punctuation">.</span>so

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样只要我们把walu.so这个文件放置在extension_dir配置的目录下，php就会在每次启动的时候自动加载了。这样我们就可以像我们平时使用curl、Mysql扩展一样直接使用，而不用麻烦的调用dl函数了。
备注： 以下的章节我们都默认使用上面的这种方式来加载我们的扩展，而不是调用dl函数。</p> <h2 id="links"><a href="#links" aria-hidden="true" class="header-anchor">#</a> links</h2> <ul><li>5.1 <a href="/PHP/phpbook/5.1.html">一个扩展的基本结构</a></li> <li>5.3 <a href="/PHP/phpbook/5.3.html">静态编译</a></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新: </span> <span class="time">7/3/2019, 11:19:32 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/162.6285f306.js" defer></script><script src="/assets/js/app.6b2c809f.js" defer></script>
  </body>
</html>
