<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.1 函数返回值 | Bing</title>
    <meta name="description" content="文档空间">
    <link rel="icon" href="https://avatars.githubusercontent.com/bingbig">
    
    <link rel="preload" href="/assets/css/0.styles.16105da8.css" as="style"><link rel="preload" href="/assets/js/app.6b2c809f.js" as="script"><link rel="preload" href="/assets/js/167.81a169ac.js" as="script"><link rel="prefetch" href="/assets/js/10.f6176989.js"><link rel="prefetch" href="/assets/js/100.0768a1d7.js"><link rel="prefetch" href="/assets/js/101.ec9cf3e3.js"><link rel="prefetch" href="/assets/js/102.66ac4896.js"><link rel="prefetch" href="/assets/js/103.401d4b10.js"><link rel="prefetch" href="/assets/js/104.b2f962d3.js"><link rel="prefetch" href="/assets/js/105.9f9dc167.js"><link rel="prefetch" href="/assets/js/106.d22423d9.js"><link rel="prefetch" href="/assets/js/107.b627322d.js"><link rel="prefetch" href="/assets/js/108.52af3356.js"><link rel="prefetch" href="/assets/js/109.f12ba199.js"><link rel="prefetch" href="/assets/js/11.647dbc36.js"><link rel="prefetch" href="/assets/js/110.a2a4e6cb.js"><link rel="prefetch" href="/assets/js/111.94c3aaaa.js"><link rel="prefetch" href="/assets/js/112.8aea190a.js"><link rel="prefetch" href="/assets/js/113.1a7ccce8.js"><link rel="prefetch" href="/assets/js/114.db890620.js"><link rel="prefetch" href="/assets/js/115.84b8a260.js"><link rel="prefetch" href="/assets/js/116.7d5268cf.js"><link rel="prefetch" href="/assets/js/117.93c01afe.js"><link rel="prefetch" href="/assets/js/118.b25aa971.js"><link rel="prefetch" href="/assets/js/119.fa014286.js"><link rel="prefetch" href="/assets/js/12.84989b4b.js"><link rel="prefetch" href="/assets/js/120.3693ed0b.js"><link rel="prefetch" href="/assets/js/121.5c0f9771.js"><link rel="prefetch" href="/assets/js/122.109848a6.js"><link rel="prefetch" href="/assets/js/123.b8ee4cff.js"><link rel="prefetch" href="/assets/js/124.552dbc17.js"><link rel="prefetch" href="/assets/js/125.883a4e39.js"><link rel="prefetch" href="/assets/js/126.d89b69d2.js"><link rel="prefetch" href="/assets/js/127.c25e84b0.js"><link rel="prefetch" href="/assets/js/128.a452bcc0.js"><link rel="prefetch" href="/assets/js/129.5901a6f1.js"><link rel="prefetch" href="/assets/js/13.e9d34bfe.js"><link rel="prefetch" href="/assets/js/130.b4288184.js"><link rel="prefetch" href="/assets/js/131.bedcaf9c.js"><link rel="prefetch" href="/assets/js/132.5d4a9fa7.js"><link rel="prefetch" href="/assets/js/133.0e8935ab.js"><link rel="prefetch" href="/assets/js/134.51191e5b.js"><link rel="prefetch" href="/assets/js/135.52fc1365.js"><link rel="prefetch" href="/assets/js/136.12ce5b0c.js"><link rel="prefetch" href="/assets/js/137.bcd4b6f9.js"><link rel="prefetch" href="/assets/js/138.ceba826f.js"><link rel="prefetch" href="/assets/js/139.ab41ed03.js"><link rel="prefetch" href="/assets/js/14.bba95746.js"><link rel="prefetch" href="/assets/js/140.9195afbf.js"><link rel="prefetch" href="/assets/js/141.52de6632.js"><link rel="prefetch" href="/assets/js/142.5991a8c3.js"><link rel="prefetch" href="/assets/js/143.2eb890d2.js"><link rel="prefetch" href="/assets/js/144.d5731614.js"><link rel="prefetch" href="/assets/js/145.9ff0d3f7.js"><link rel="prefetch" href="/assets/js/146.62553ebb.js"><link rel="prefetch" href="/assets/js/147.5bb534ce.js"><link rel="prefetch" href="/assets/js/148.cfdcb4b2.js"><link rel="prefetch" href="/assets/js/149.ffb0f335.js"><link rel="prefetch" href="/assets/js/15.abdbf40e.js"><link rel="prefetch" href="/assets/js/150.3fa2add3.js"><link rel="prefetch" href="/assets/js/151.d9de380a.js"><link rel="prefetch" href="/assets/js/152.8820d383.js"><link rel="prefetch" href="/assets/js/153.1a7deb16.js"><link rel="prefetch" href="/assets/js/154.8a8d04d5.js"><link rel="prefetch" href="/assets/js/155.e596bd6e.js"><link rel="prefetch" href="/assets/js/156.f93ffc96.js"><link rel="prefetch" href="/assets/js/157.1d4e442a.js"><link rel="prefetch" href="/assets/js/158.5bfb982e.js"><link rel="prefetch" href="/assets/js/159.bbdebf53.js"><link rel="prefetch" href="/assets/js/16.23a09bd0.js"><link rel="prefetch" href="/assets/js/160.c5eae96d.js"><link rel="prefetch" href="/assets/js/161.a2241d1a.js"><link rel="prefetch" href="/assets/js/162.6285f306.js"><link rel="prefetch" href="/assets/js/163.7e424328.js"><link rel="prefetch" href="/assets/js/164.250fa087.js"><link rel="prefetch" href="/assets/js/165.6cf851be.js"><link rel="prefetch" href="/assets/js/166.17548140.js"><link rel="prefetch" href="/assets/js/168.21634c85.js"><link rel="prefetch" href="/assets/js/169.5cb2c187.js"><link rel="prefetch" href="/assets/js/17.26a3f651.js"><link rel="prefetch" href="/assets/js/170.842ec593.js"><link rel="prefetch" href="/assets/js/171.5fe1f306.js"><link rel="prefetch" href="/assets/js/172.57d63125.js"><link rel="prefetch" href="/assets/js/173.17e0e721.js"><link rel="prefetch" href="/assets/js/174.cd1048c8.js"><link rel="prefetch" href="/assets/js/175.2a9ed138.js"><link rel="prefetch" href="/assets/js/176.63b2df6e.js"><link rel="prefetch" href="/assets/js/177.ab26fd53.js"><link rel="prefetch" href="/assets/js/178.f2760c4a.js"><link rel="prefetch" href="/assets/js/179.581bbced.js"><link rel="prefetch" href="/assets/js/18.34749364.js"><link rel="prefetch" href="/assets/js/180.b390c5bb.js"><link rel="prefetch" href="/assets/js/181.385f7953.js"><link rel="prefetch" href="/assets/js/182.6cfb5179.js"><link rel="prefetch" href="/assets/js/183.4418d89d.js"><link rel="prefetch" href="/assets/js/184.f62d568a.js"><link rel="prefetch" href="/assets/js/185.652389ca.js"><link rel="prefetch" href="/assets/js/186.a15b5381.js"><link rel="prefetch" href="/assets/js/187.7e93ef83.js"><link rel="prefetch" href="/assets/js/188.188b9aa4.js"><link rel="prefetch" href="/assets/js/189.58d2adc8.js"><link rel="prefetch" href="/assets/js/19.33b6e0d9.js"><link rel="prefetch" href="/assets/js/190.f31d04b6.js"><link rel="prefetch" href="/assets/js/191.497232ef.js"><link rel="prefetch" href="/assets/js/192.a2045cfc.js"><link rel="prefetch" href="/assets/js/193.b430b41f.js"><link rel="prefetch" href="/assets/js/194.33a6fd3b.js"><link rel="prefetch" href="/assets/js/195.82574543.js"><link rel="prefetch" href="/assets/js/196.27161d59.js"><link rel="prefetch" href="/assets/js/197.e546d765.js"><link rel="prefetch" href="/assets/js/198.a3dc4687.js"><link rel="prefetch" href="/assets/js/199.7e1730f0.js"><link rel="prefetch" href="/assets/js/2.c4c7f0aa.js"><link rel="prefetch" href="/assets/js/20.be43276b.js"><link rel="prefetch" href="/assets/js/200.0ebceee7.js"><link rel="prefetch" href="/assets/js/201.ffa9096a.js"><link rel="prefetch" href="/assets/js/202.dea9f407.js"><link rel="prefetch" href="/assets/js/203.65f71b7b.js"><link rel="prefetch" href="/assets/js/204.6eccc640.js"><link rel="prefetch" href="/assets/js/205.37e32653.js"><link rel="prefetch" href="/assets/js/206.770c36ba.js"><link rel="prefetch" href="/assets/js/207.9cab62e1.js"><link rel="prefetch" href="/assets/js/208.e7eccf84.js"><link rel="prefetch" href="/assets/js/209.ce1441e1.js"><link rel="prefetch" href="/assets/js/21.7db2670e.js"><link rel="prefetch" href="/assets/js/210.e5a10df7.js"><link rel="prefetch" href="/assets/js/211.06c60da9.js"><link rel="prefetch" href="/assets/js/212.bf6984bf.js"><link rel="prefetch" href="/assets/js/213.c22eb113.js"><link rel="prefetch" href="/assets/js/214.3aab7d1f.js"><link rel="prefetch" href="/assets/js/215.5b082314.js"><link rel="prefetch" href="/assets/js/216.340588a3.js"><link rel="prefetch" href="/assets/js/217.9b3c8940.js"><link rel="prefetch" href="/assets/js/218.c38d9710.js"><link rel="prefetch" href="/assets/js/219.f21e2c60.js"><link rel="prefetch" href="/assets/js/22.e10869f6.js"><link rel="prefetch" href="/assets/js/220.38b3038d.js"><link rel="prefetch" href="/assets/js/221.ba426e65.js"><link rel="prefetch" href="/assets/js/222.265c024f.js"><link rel="prefetch" href="/assets/js/223.66962a7a.js"><link rel="prefetch" href="/assets/js/224.96713221.js"><link rel="prefetch" href="/assets/js/225.8915aaa4.js"><link rel="prefetch" href="/assets/js/226.6b285af0.js"><link rel="prefetch" href="/assets/js/227.b47d9853.js"><link rel="prefetch" href="/assets/js/228.9f6cbae9.js"><link rel="prefetch" href="/assets/js/23.1090bcef.js"><link rel="prefetch" href="/assets/js/24.42ca9d60.js"><link rel="prefetch" href="/assets/js/25.51778f79.js"><link rel="prefetch" href="/assets/js/26.fd01a47c.js"><link rel="prefetch" href="/assets/js/27.dacd7ea5.js"><link rel="prefetch" href="/assets/js/28.463ba231.js"><link rel="prefetch" href="/assets/js/29.ac24f130.js"><link rel="prefetch" href="/assets/js/3.803cd987.js"><link rel="prefetch" href="/assets/js/30.5fa4570d.js"><link rel="prefetch" href="/assets/js/31.8b53ab8a.js"><link rel="prefetch" href="/assets/js/32.2b71f979.js"><link rel="prefetch" href="/assets/js/33.377c2bbd.js"><link rel="prefetch" href="/assets/js/34.aa0b55c3.js"><link rel="prefetch" href="/assets/js/35.841f5ce9.js"><link rel="prefetch" href="/assets/js/36.b3151090.js"><link rel="prefetch" href="/assets/js/37.dd466b10.js"><link rel="prefetch" href="/assets/js/38.7631230b.js"><link rel="prefetch" href="/assets/js/39.bdbd4150.js"><link rel="prefetch" href="/assets/js/4.f376888f.js"><link rel="prefetch" href="/assets/js/40.bd0aba4d.js"><link rel="prefetch" href="/assets/js/41.fb240faa.js"><link rel="prefetch" href="/assets/js/42.573f42b6.js"><link rel="prefetch" href="/assets/js/43.f3ab36d0.js"><link rel="prefetch" href="/assets/js/44.d72fbc07.js"><link rel="prefetch" href="/assets/js/45.a2c94371.js"><link rel="prefetch" href="/assets/js/46.e22c3a4d.js"><link rel="prefetch" href="/assets/js/47.699bd039.js"><link rel="prefetch" href="/assets/js/48.643e09ec.js"><link rel="prefetch" href="/assets/js/49.5593dccf.js"><link rel="prefetch" href="/assets/js/5.aa717142.js"><link rel="prefetch" href="/assets/js/50.bfb98f44.js"><link rel="prefetch" href="/assets/js/51.bb668b1f.js"><link rel="prefetch" href="/assets/js/52.a1e166b8.js"><link rel="prefetch" href="/assets/js/53.d9d4ab66.js"><link rel="prefetch" href="/assets/js/54.365f1440.js"><link rel="prefetch" href="/assets/js/55.aa7a99bc.js"><link rel="prefetch" href="/assets/js/56.f71d3bdc.js"><link rel="prefetch" href="/assets/js/57.c22489ff.js"><link rel="prefetch" href="/assets/js/58.961cb551.js"><link rel="prefetch" href="/assets/js/59.625c571b.js"><link rel="prefetch" href="/assets/js/6.2c0dbfe9.js"><link rel="prefetch" href="/assets/js/60.7cad7d61.js"><link rel="prefetch" href="/assets/js/61.3ab2039b.js"><link rel="prefetch" href="/assets/js/62.ebbcc7a8.js"><link rel="prefetch" href="/assets/js/63.022f6fe1.js"><link rel="prefetch" href="/assets/js/64.cfc0dcb3.js"><link rel="prefetch" href="/assets/js/65.4f892233.js"><link rel="prefetch" href="/assets/js/66.6e6574c2.js"><link rel="prefetch" href="/assets/js/67.40fb186e.js"><link rel="prefetch" href="/assets/js/68.54858ca7.js"><link rel="prefetch" href="/assets/js/69.e028e80f.js"><link rel="prefetch" href="/assets/js/7.3d66d209.js"><link rel="prefetch" href="/assets/js/70.9c1a0d51.js"><link rel="prefetch" href="/assets/js/71.9e6467f5.js"><link rel="prefetch" href="/assets/js/72.60bfce27.js"><link rel="prefetch" href="/assets/js/73.9ec43056.js"><link rel="prefetch" href="/assets/js/74.0aa6072f.js"><link rel="prefetch" href="/assets/js/75.865d7dda.js"><link rel="prefetch" href="/assets/js/76.fc1f0140.js"><link rel="prefetch" href="/assets/js/77.51e20bb9.js"><link rel="prefetch" href="/assets/js/78.93dbf54e.js"><link rel="prefetch" href="/assets/js/79.7a5b89c7.js"><link rel="prefetch" href="/assets/js/8.5b98a3a4.js"><link rel="prefetch" href="/assets/js/80.d2e23095.js"><link rel="prefetch" href="/assets/js/81.8b16c2f7.js"><link rel="prefetch" href="/assets/js/82.db077248.js"><link rel="prefetch" href="/assets/js/83.360d0cb4.js"><link rel="prefetch" href="/assets/js/84.50dadff3.js"><link rel="prefetch" href="/assets/js/85.0111e9a1.js"><link rel="prefetch" href="/assets/js/86.b2425a36.js"><link rel="prefetch" href="/assets/js/87.63aebc19.js"><link rel="prefetch" href="/assets/js/88.479041f7.js"><link rel="prefetch" href="/assets/js/89.769c409d.js"><link rel="prefetch" href="/assets/js/9.520db884.js"><link rel="prefetch" href="/assets/js/90.2ec7b507.js"><link rel="prefetch" href="/assets/js/91.9cae6dae.js"><link rel="prefetch" href="/assets/js/92.7863085a.js"><link rel="prefetch" href="/assets/js/93.3023daa8.js"><link rel="prefetch" href="/assets/js/94.7ffa85cb.js"><link rel="prefetch" href="/assets/js/95.b8b1e5dc.js"><link rel="prefetch" href="/assets/js/96.79ba50a3.js"><link rel="prefetch" href="/assets/js/97.988cb9bc.js"><link rel="prefetch" href="/assets/js/98.95938b5a.js"><link rel="prefetch" href="/assets/js/99.4842d35c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16105da8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bing</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/PHP/content.html" class="sidebar-link">PHP</a></li><li><a href="/PHP/basic.html" class="sidebar-link">PHP基础知识</a></li><li><a href="/PHP/tips.html" class="sidebar-link">PHP编程技巧与优化</a></li><li><a href="/PHP/sugs.html" class="sidebar-link">PHP 安全编程建议</a></li><li><a href="/PHP/static.html" class="sidebar-link">Static</a></li><li><a href="/PHP/router.html" class="sidebar-link">PHP路由技术的原理与实践</a></li><li><a href="/PHP/composer.html" class="sidebar-link">Composer</a></li><li><a href="/PHP/OOP/SRP.html" class="sidebar-link">单一职责原则SRP</a></li><li><a href="/PHP/OOP/OCP.html" class="sidebar-link">开闭原则OCP</a></li><li><a href="/PHP/OOP/LSP.html" class="sidebar-link">里氏替换原则LSP</a></li><li><a href="/PHP/OOP/ISP.html" class="sidebar-link">接口隔离原则ISP</a></li><li><a href="/PHP/OOP/DIP.html" class="sidebar-link">依赖倒置原则DIP</a></li><li><a href="/PHP/OOP/abstract_class.html" class="sidebar-link">抽象类</a></li><li><a href="/PHP/Laravel/Container.html" class="sidebar-link">Laravel 源码阅读 －容器</a></li><li><a href="/PHP/pattern/singleton.html" class="sidebar-link">单例模式</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="_6-1-函数返回值"><a href="#_6-1-函数返回值" aria-hidden="true" class="header-anchor">#</a> 6.1 函数返回值</h1> <p>你也许会认为扩展中定义的函数应该直接通过return关键字来返回一个值，比如由你自己来生成一个zval并返回，就像下面这样：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>sample_long_wrong<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    zval <span class="token operator">*</span>retval<span class="token punctuation">;</span>

    <span class="token function">MAKE_STD_ZVAL</span><span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ZVAL_LONG</span><span class="token punctuation">(</span>retval<span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>但是，上面的写法是无效的！与其让扩展开发员每次都初始化一个zval并return之，zend引擎早就准备好了一个更好的方法。它在每个zif函数声明里加了一个zval*类型的形参，名为return_value，专门来解决返回值这个问题。在前面我们已经知道了ZEND_FUNCTION宏展开后是void name(INTERNAL_FUNCTION_PARAMETERS)的形式，现在是我们展开代表参数声明的INTERNAL_FUNCTION_PARAMETERS宏的时候了。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> INTERNAL_FUNCTION_PARAMETERS int ht, zval *return_value, zval **return_value_ptr, zval *this_ptr, int return_value_used TSRMLS_DC</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>int ht</li> <li>zval *return_value，我们在函数内部修改这个指针，函数执行完成后，内核将把这个指针指向的zval返回给用户端的函数调用者。</li> <li>zval **return_value_ptr，</li> <li>zval *this_ptr，如果此函数是一个类的方法，那么这个指针的含义和PHP语言中$this变量差不多。</li> <li>int return_value_used，代表用户端在调用此函数时有没有使用到它的返回值。</li></ul>
下面让我们先试验一个非常简单的例子，我先给出PHP语言中的实现，然后给出我们在扩展中用C语言完成相同功能的代码。
<div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">sample_long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
	这个函数非常简单.
	$a = sample_long();
	那此时$a的值便是42了，这个我们大家肯定都明白。
*/</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>下面是我们在编写扩展时的实现。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>sample_long<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">ZVAL_LONG</span><span class="token punctuation">(</span>return_value<span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>需要注意的是，ZEND_FUNCTION本身并没有通过return关键字返回任何有价值的东西，它只不过是在运行时修改了<code>return_value</code>指针所指向的变量的值而已，而内核则会把<code>return_value</code>指向的变量作为用户端调用此函数后的得到的返回值。回想一下,ZVAL_LONG()宏是对一类操作的封装，展开后应该就是下面这样：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">Z_TYPE_P</span><span class="token punctuation">(</span>return_value<span class="token punctuation">)</span> <span class="token operator">=</span> IS_LONG<span class="token punctuation">;</span>
<span class="token function">Z_LVAL_P</span><span class="token punctuation">(</span>return_value<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>

<span class="token comment">//更彻底的讲，应该是这样的：</span>
return_value<span class="token operator">-&gt;</span>type <span class="token operator">=</span> IS_LONG<span class="token punctuation">;</span>
return_value<span class="token operator">-&gt;</span>value<span class="token punctuation">.</span>lval <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>我们千万不要自己去修改<code>return_value</code>的<code>is_ref__gc</code>和<code>refcount__gc</code>属性，这两个属性的值会由PHP内核自动管理。</strong></p> <p>现在我们把它加到我们在第五章得到的那个扩展框架里，并把这个函数名称注册到函数入口数组里，就像下面这样：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> zend_function_entry walu_functions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">ZEND_FE</span><span class="token punctuation">(</span>walu_hello<span class="token punctuation">,</span>        <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token function">PHP_FE</span><span class="token punctuation">(</span>sample_long<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在我们编译我们的扩展，便可以在用户端通过调用sample_long函数来得到一个整型的返回值了:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">sample_long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="与return-value有关的宏"><a href="#与return-value有关的宏" aria-hidden="true" class="header-anchor">#</a> 与return_value有关的宏</h3> <p>return_value如此重要，内核肯定早已经为它准备了大量的宏，来简化我们的操作，提高程序的质量。
在前几章我们接触的宏大多都是以ZVAL_开头的，而接下来我们要介绍的宏的名字是：RETVAL。
再回到上面的那个例子，我们用RETVAL来重写一下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>sample_long<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">RETVAL_LONG</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//展开后相当与ZVAL_LONG(return_value, 42);</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>大多数情况下，我们在处理完return_value后所做的便是用return语句结束我们的函数执行，帮人帮到底，送佛送到西，为了减少我们的工作量，内核中还提供了RETURN_*系列宏来为我们自动补上return;如：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>sample_long<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">RETURN_LONG</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//#define RETURN_LONG(l) { RETVAL_LONG(l); return; }</span>
    <span class="token function">php_printf</span><span class="token punctuation">(</span><span class="token string">&quot;I will never be reached.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这一行代码永远不会被执行。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>下面，我们给出目前所有的<code>RETVAL_***</code>宏和<code>RETURN_***</code>宏，供大家查阅使用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//这些宏都定义在Zend/zend_API.h文件里</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_RESOURCE(l)				ZVAL_RESOURCE(return_value, l)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_BOOL(b)					ZVAL_BOOL(return_value, b)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_NULL() 					ZVAL_NULL(return_value)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_LONG(l) 					ZVAL_LONG(return_value, l)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_DOUBLE(d) 				ZVAL_DOUBLE(return_value, d)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_STRING(s, duplicate) 		ZVAL_STRING(return_value, s, duplicate)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_STRINGL(s, l, duplicate) 	ZVAL_STRINGL(return_value, s, l, duplicate)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_EMPTY_STRING() 			ZVAL_EMPTY_STRING(return_value)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_ZVAL(zv, copy, dtor)		ZVAL_ZVAL(return_value, zv, copy, dtor)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_FALSE  					ZVAL_BOOL(return_value, 0)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETVAL_TRUE   					ZVAL_BOOL(return_value, 1)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_RESOURCE(l) 				{ RETVAL_RESOURCE(l); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_BOOL(b) 					{ RETVAL_BOOL(b); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_NULL() 					{ RETVAL_NULL(); return;}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_LONG(l) 					{ RETVAL_LONG(l); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_DOUBLE(d) 				{ RETVAL_DOUBLE(d); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_STRING(s, duplicate) 	{ RETVAL_STRING(s, duplicate); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_STRINGL(s, l, duplicate) { RETVAL_STRINGL(s, l, duplicate); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_EMPTY_STRING() 			{ RETVAL_EMPTY_STRING(); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_ZVAL(zv, copy, dtor)		{ RETVAL_ZVAL(zv, copy, dtor); return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_FALSE  					{ RETVAL_FALSE; return; }</span>
<span class="token macro property">#<span class="token directive keyword">define</span> RETURN_TRUE   					{ RETVAL_TRUE; return; }</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>其实，除了这些标量类型，还有很多php语言中的复合类型我们需要在函数中返回，如数组和对象，我们可以通过RETVAL_ZVAL与RETURN_ZVAL来操作它们，有关它们的详细介绍我们将在后续章节中叙述。</p> <h3 id="不返回值可以么？"><a href="#不返回值可以么？" aria-hidden="true" class="header-anchor">#</a> 不返回值可以么？</h3> <p>其实，zend internal function的形参中还有一个比较常用的名为<code>return_value_used</code>的参数，它是干嘛使的呢？它用来标志这个函数的返回值在用户端有没有用到。看下面的代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token keyword">function</span> <span class="token function">sample_array_range</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">sample_array_range</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>sample_array_range()仅仅是执行了一下而已，并没有使用到函数的返回值。函数的返回值$ret初始化并返回给调用者后根本就没有发挥作用，却白白浪费了很多内存来存储它的1000个元素。虽然这个例子有点极端，但是却提醒了我们，如果返回值没有被用到，我有没有办法在函数中提前知晓并进行一些有利于性能的操作呢？
这个想法在PHP脚本语言里简直就是异想天开，肯定是无法实现的。但是如果我们所处的环境是内核，即zif，便可以轻松实现这个愿望了，而我们所需要做的便是充分利用<code>return_value_used</code>这个参数：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>sample_array_range<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_value_used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        
        <span class="token comment">//把返回值初始化成一个PHP语言中的数组</span>
        <span class="token function">array_init</span><span class="token punctuation">(</span>return_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//向retrun_value里不断的添加新元素，值为i</span>
            <span class="token function">add_next_index_long</span><span class="token punctuation">(</span>return_value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//抛出一个E_NOTICE级错误</span>
        <span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span> TSRMLS_CC<span class="token punctuation">,</span> E_NOTICE<span class="token punctuation">,</span><span class="token string">&quot;猫了个咪的，我就知道你没用我的劳动成果！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RETURN_NULL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="以引用的形式返回值"><a href="#以引用的形式返回值" aria-hidden="true" class="header-anchor">#</a> 以引用的形式返回值</h3> <p>你肯定已经在手册中看到过有关将函数的返回值以引用的形式的返回的技术了。但是因为某些历史原因，在为扩展编写函数时候如果想让返回值以引用的形式返回时一定要慎之又慎，因为在php5.1之前，根本就没法真正的实现这个功能，look一下下面的代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//关于PHP语言中引用形式返回值的详述，请参考PHP手册。</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'china'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">&amp;</span><span class="token function">return_by_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">global</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">return_by_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;php&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token comment">//此时程序输出php</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在上面的代码中，$b其实是$a的一个引用，当最后一行代码执行后，$a和$b都开始寻找‘bar’这个字符串对应的zval，让我们以内核的角度重新观察这一切：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">if</span> (PHP_MAJOR_VERSION &gt; 5) || (PHP_MAJOR_VERSION == 5 &amp;&amp; PHP_MINOR_VERSION &gt; 0)</span>
<span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>return_by_ref<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	zval <span class="token operator">*</span><span class="token operator">*</span>a_ptr<span class="token punctuation">;</span>
	zval <span class="token operator">*</span>a<span class="token punctuation">;</span>
	
	<span class="token comment">//检查全局作用域中是否有$a这个变量，如果没有则添加一个</span>
	<span class="token comment">//在内核中真的是可以胡作非为啊，:-)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">zend_hash_find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">EG</span><span class="token punctuation">(</span>symbol_table<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a_ptr <span class="token punctuation">)</span> <span class="token operator">==</span> SUCCESS <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token operator">*</span>a_ptr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token function">ALLOC_INIT_ZVAL</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">zend_hash_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">EG</span><span class="token punctuation">(</span>symbol_table<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>zval<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//废弃return_value,使用return_value_ptr来接替它的工作</span>
	<span class="token function">zval_ptr_dtor</span><span class="token punctuation">(</span>return_value_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>a<span class="token operator">-&gt;</span>is_ref__gc <span class="token operator">&amp;&amp;</span> a<span class="token operator">-&gt;</span>refcount__gc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		zval <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
		<span class="token function">MAKE_STD_ZVAL</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>tmp <span class="token operator">=</span> <span class="token operator">*</span>a<span class="token punctuation">;</span>
		<span class="token function">zval_copy_ctor</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tmp<span class="token operator">-&gt;</span>is_ref__gc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		tmp<span class="token operator">-&gt;</span>refcount__gc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">zend_hash_update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">EG</span><span class="token punctuation">(</span>symbol_table<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>zval<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		a <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	a<span class="token operator">-&gt;</span>is_ref__gc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	a<span class="token operator">-&gt;</span>refcount__gc<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>return_value_ptr <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* PHP &gt;= 5.1.0 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>return_value_ptr是定义zend internal function时的另外一个重要参数，他是一个zval**类型的指针，并且指向函数的返回值。我们调用zval_ptr_dtor()函数后，默认的return_value便被废弃了。这里的$a变量如果是与某个非引用形式的变量共用一个zval的话，便要进行分离。
不幸的是，如果你编译上面的代码，使用的时候便会得到一个段错误。为了使它能够正常的工作，需要在源文件中加一些东西：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">if</span> (PHP_MAJOR_VERSION &gt; 5) || (PHP_MAJOR_VERSION == 5 &amp;&amp; PHP_MINOR_VERSION &gt; 0)</span>
    <span class="token function">ZEND_BEGIN_ARG_INFO_EX</span><span class="token punctuation">(</span>return_by_ref_arginfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    ZEND_END_ARG_INFO <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* PHP &gt;= 5.1.0 */</span>

然后使用下面的代码来申明我们的定义的函数：
<span class="token macro property">#<span class="token directive keyword">if</span> (PHP_MAJOR_VERSION &gt; 5) || (PHP_MAJOR_VERSION == 5 &amp;&amp; PHP_MINOR_VERSION &gt; 0)</span>
    <span class="token function">ZEND_FE</span><span class="token punctuation">(</span>return_by_ref<span class="token punctuation">,</span> return_by_ref_arginfo<span class="token punctuation">)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* PHP &gt;= 5.1.0 */</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>arginfo是一种特殊的结构体，用来提前向内核告知此函数具有的一些特定的性质，如本例，其将告诉内核本函数需要引用形式的返回值，所以内核不再通过return_value来获取执行结果，而是通过return_value_ptr。如果没有arginfo，那内核会预先把return_value_ptr置为NULL，当我们对其调用zval_ptr_dtor()函数时便会使程序崩溃。
</p><div class="tip-warning">这一些代码都包含在了一个宏里面，只有在php版本大于等于5.1的时候才会被启用。如果没有这些if、endif，那我们的程序将无法在php4下通过编译，在php5.0上也会激活一些无法预测的错误。</div> <hr> <ul><li>zone(zqx10104#163.com)于2011-10-20提供了一个Bug，😃</li></ul><p></p> <h2 id="links"><a href="#links" aria-hidden="true" class="header-anchor">#</a> links</h2> <ul><li>6 <a href="/PHP/phpbook/6.html">函数返回值</a></li> <li>6.2 <a href="/PHP/phpbook/6.2.html">引用与函数的执行结果</a></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新: </span> <span class="time">7/3/2019, 10:47:37 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/167.81a169ac.js" defer></script><script src="/assets/js/app.6b2c809f.js" defer></script>
  </body>
</html>
