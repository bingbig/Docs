<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>9.1 PHP中的资源类型 | Bing</title>
    <meta name="description" content="文档空间">
    <link rel="icon" href="https://avatars.githubusercontent.com/bingbig">
    
    <link rel="preload" href="/assets/css/0.styles.16105da8.css" as="style"><link rel="preload" href="/assets/js/app.6b2c809f.js" as="script"><link rel="preload" href="/assets/js/180.b390c5bb.js" as="script"><link rel="prefetch" href="/assets/js/10.f6176989.js"><link rel="prefetch" href="/assets/js/100.0768a1d7.js"><link rel="prefetch" href="/assets/js/101.ec9cf3e3.js"><link rel="prefetch" href="/assets/js/102.66ac4896.js"><link rel="prefetch" href="/assets/js/103.401d4b10.js"><link rel="prefetch" href="/assets/js/104.b2f962d3.js"><link rel="prefetch" href="/assets/js/105.9f9dc167.js"><link rel="prefetch" href="/assets/js/106.d22423d9.js"><link rel="prefetch" href="/assets/js/107.b627322d.js"><link rel="prefetch" href="/assets/js/108.52af3356.js"><link rel="prefetch" href="/assets/js/109.f12ba199.js"><link rel="prefetch" href="/assets/js/11.647dbc36.js"><link rel="prefetch" href="/assets/js/110.a2a4e6cb.js"><link rel="prefetch" href="/assets/js/111.94c3aaaa.js"><link rel="prefetch" href="/assets/js/112.8aea190a.js"><link rel="prefetch" href="/assets/js/113.1a7ccce8.js"><link rel="prefetch" href="/assets/js/114.db890620.js"><link rel="prefetch" href="/assets/js/115.84b8a260.js"><link rel="prefetch" href="/assets/js/116.7d5268cf.js"><link rel="prefetch" href="/assets/js/117.93c01afe.js"><link rel="prefetch" href="/assets/js/118.b25aa971.js"><link rel="prefetch" href="/assets/js/119.fa014286.js"><link rel="prefetch" href="/assets/js/12.84989b4b.js"><link rel="prefetch" href="/assets/js/120.3693ed0b.js"><link rel="prefetch" href="/assets/js/121.5c0f9771.js"><link rel="prefetch" href="/assets/js/122.109848a6.js"><link rel="prefetch" href="/assets/js/123.b8ee4cff.js"><link rel="prefetch" href="/assets/js/124.552dbc17.js"><link rel="prefetch" href="/assets/js/125.883a4e39.js"><link rel="prefetch" href="/assets/js/126.d89b69d2.js"><link rel="prefetch" href="/assets/js/127.c25e84b0.js"><link rel="prefetch" href="/assets/js/128.a452bcc0.js"><link rel="prefetch" href="/assets/js/129.5901a6f1.js"><link rel="prefetch" href="/assets/js/13.e9d34bfe.js"><link rel="prefetch" href="/assets/js/130.b4288184.js"><link rel="prefetch" href="/assets/js/131.bedcaf9c.js"><link rel="prefetch" href="/assets/js/132.5d4a9fa7.js"><link rel="prefetch" href="/assets/js/133.0e8935ab.js"><link rel="prefetch" href="/assets/js/134.51191e5b.js"><link rel="prefetch" href="/assets/js/135.52fc1365.js"><link rel="prefetch" href="/assets/js/136.12ce5b0c.js"><link rel="prefetch" href="/assets/js/137.bcd4b6f9.js"><link rel="prefetch" href="/assets/js/138.ceba826f.js"><link rel="prefetch" href="/assets/js/139.ab41ed03.js"><link rel="prefetch" href="/assets/js/14.bba95746.js"><link rel="prefetch" href="/assets/js/140.9195afbf.js"><link rel="prefetch" href="/assets/js/141.52de6632.js"><link rel="prefetch" href="/assets/js/142.5991a8c3.js"><link rel="prefetch" href="/assets/js/143.2eb890d2.js"><link rel="prefetch" href="/assets/js/144.d5731614.js"><link rel="prefetch" href="/assets/js/145.9ff0d3f7.js"><link rel="prefetch" href="/assets/js/146.62553ebb.js"><link rel="prefetch" href="/assets/js/147.5bb534ce.js"><link rel="prefetch" href="/assets/js/148.cfdcb4b2.js"><link rel="prefetch" href="/assets/js/149.ffb0f335.js"><link rel="prefetch" href="/assets/js/15.abdbf40e.js"><link rel="prefetch" href="/assets/js/150.3fa2add3.js"><link rel="prefetch" href="/assets/js/151.d9de380a.js"><link rel="prefetch" href="/assets/js/152.8820d383.js"><link rel="prefetch" href="/assets/js/153.1a7deb16.js"><link rel="prefetch" href="/assets/js/154.8a8d04d5.js"><link rel="prefetch" href="/assets/js/155.e596bd6e.js"><link rel="prefetch" href="/assets/js/156.f93ffc96.js"><link rel="prefetch" href="/assets/js/157.1d4e442a.js"><link rel="prefetch" href="/assets/js/158.5bfb982e.js"><link rel="prefetch" href="/assets/js/159.bbdebf53.js"><link rel="prefetch" href="/assets/js/16.23a09bd0.js"><link rel="prefetch" href="/assets/js/160.c5eae96d.js"><link rel="prefetch" href="/assets/js/161.a2241d1a.js"><link rel="prefetch" href="/assets/js/162.6285f306.js"><link rel="prefetch" href="/assets/js/163.7e424328.js"><link rel="prefetch" href="/assets/js/164.250fa087.js"><link rel="prefetch" href="/assets/js/165.6cf851be.js"><link rel="prefetch" href="/assets/js/166.17548140.js"><link rel="prefetch" href="/assets/js/167.81a169ac.js"><link rel="prefetch" href="/assets/js/168.21634c85.js"><link rel="prefetch" href="/assets/js/169.5cb2c187.js"><link rel="prefetch" href="/assets/js/17.26a3f651.js"><link rel="prefetch" href="/assets/js/170.842ec593.js"><link rel="prefetch" href="/assets/js/171.5fe1f306.js"><link rel="prefetch" href="/assets/js/172.57d63125.js"><link rel="prefetch" href="/assets/js/173.17e0e721.js"><link rel="prefetch" href="/assets/js/174.cd1048c8.js"><link rel="prefetch" href="/assets/js/175.2a9ed138.js"><link rel="prefetch" href="/assets/js/176.63b2df6e.js"><link rel="prefetch" href="/assets/js/177.ab26fd53.js"><link rel="prefetch" href="/assets/js/178.f2760c4a.js"><link rel="prefetch" href="/assets/js/179.581bbced.js"><link rel="prefetch" href="/assets/js/18.34749364.js"><link rel="prefetch" href="/assets/js/181.385f7953.js"><link rel="prefetch" href="/assets/js/182.6cfb5179.js"><link rel="prefetch" href="/assets/js/183.4418d89d.js"><link rel="prefetch" href="/assets/js/184.f62d568a.js"><link rel="prefetch" href="/assets/js/185.652389ca.js"><link rel="prefetch" href="/assets/js/186.a15b5381.js"><link rel="prefetch" href="/assets/js/187.7e93ef83.js"><link rel="prefetch" href="/assets/js/188.188b9aa4.js"><link rel="prefetch" href="/assets/js/189.58d2adc8.js"><link rel="prefetch" href="/assets/js/19.33b6e0d9.js"><link rel="prefetch" href="/assets/js/190.f31d04b6.js"><link rel="prefetch" href="/assets/js/191.497232ef.js"><link rel="prefetch" href="/assets/js/192.a2045cfc.js"><link rel="prefetch" href="/assets/js/193.b430b41f.js"><link rel="prefetch" href="/assets/js/194.33a6fd3b.js"><link rel="prefetch" href="/assets/js/195.82574543.js"><link rel="prefetch" href="/assets/js/196.27161d59.js"><link rel="prefetch" href="/assets/js/197.e546d765.js"><link rel="prefetch" href="/assets/js/198.a3dc4687.js"><link rel="prefetch" href="/assets/js/199.7e1730f0.js"><link rel="prefetch" href="/assets/js/2.c4c7f0aa.js"><link rel="prefetch" href="/assets/js/20.be43276b.js"><link rel="prefetch" href="/assets/js/200.0ebceee7.js"><link rel="prefetch" href="/assets/js/201.ffa9096a.js"><link rel="prefetch" href="/assets/js/202.dea9f407.js"><link rel="prefetch" href="/assets/js/203.65f71b7b.js"><link rel="prefetch" href="/assets/js/204.6eccc640.js"><link rel="prefetch" href="/assets/js/205.37e32653.js"><link rel="prefetch" href="/assets/js/206.770c36ba.js"><link rel="prefetch" href="/assets/js/207.9cab62e1.js"><link rel="prefetch" href="/assets/js/208.e7eccf84.js"><link rel="prefetch" href="/assets/js/209.ce1441e1.js"><link rel="prefetch" href="/assets/js/21.7db2670e.js"><link rel="prefetch" href="/assets/js/210.e5a10df7.js"><link rel="prefetch" href="/assets/js/211.06c60da9.js"><link rel="prefetch" href="/assets/js/212.bf6984bf.js"><link rel="prefetch" href="/assets/js/213.c22eb113.js"><link rel="prefetch" href="/assets/js/214.3aab7d1f.js"><link rel="prefetch" href="/assets/js/215.5b082314.js"><link rel="prefetch" href="/assets/js/216.340588a3.js"><link rel="prefetch" href="/assets/js/217.9b3c8940.js"><link rel="prefetch" href="/assets/js/218.c38d9710.js"><link rel="prefetch" href="/assets/js/219.f21e2c60.js"><link rel="prefetch" href="/assets/js/22.e10869f6.js"><link rel="prefetch" href="/assets/js/220.38b3038d.js"><link rel="prefetch" href="/assets/js/221.ba426e65.js"><link rel="prefetch" href="/assets/js/222.265c024f.js"><link rel="prefetch" href="/assets/js/223.66962a7a.js"><link rel="prefetch" href="/assets/js/224.96713221.js"><link rel="prefetch" href="/assets/js/225.8915aaa4.js"><link rel="prefetch" href="/assets/js/226.6b285af0.js"><link rel="prefetch" href="/assets/js/227.b47d9853.js"><link rel="prefetch" href="/assets/js/228.9f6cbae9.js"><link rel="prefetch" href="/assets/js/23.1090bcef.js"><link rel="prefetch" href="/assets/js/24.42ca9d60.js"><link rel="prefetch" href="/assets/js/25.51778f79.js"><link rel="prefetch" href="/assets/js/26.fd01a47c.js"><link rel="prefetch" href="/assets/js/27.dacd7ea5.js"><link rel="prefetch" href="/assets/js/28.463ba231.js"><link rel="prefetch" href="/assets/js/29.ac24f130.js"><link rel="prefetch" href="/assets/js/3.803cd987.js"><link rel="prefetch" href="/assets/js/30.5fa4570d.js"><link rel="prefetch" href="/assets/js/31.8b53ab8a.js"><link rel="prefetch" href="/assets/js/32.2b71f979.js"><link rel="prefetch" href="/assets/js/33.377c2bbd.js"><link rel="prefetch" href="/assets/js/34.aa0b55c3.js"><link rel="prefetch" href="/assets/js/35.841f5ce9.js"><link rel="prefetch" href="/assets/js/36.b3151090.js"><link rel="prefetch" href="/assets/js/37.dd466b10.js"><link rel="prefetch" href="/assets/js/38.7631230b.js"><link rel="prefetch" href="/assets/js/39.bdbd4150.js"><link rel="prefetch" href="/assets/js/4.f376888f.js"><link rel="prefetch" href="/assets/js/40.bd0aba4d.js"><link rel="prefetch" href="/assets/js/41.fb240faa.js"><link rel="prefetch" href="/assets/js/42.573f42b6.js"><link rel="prefetch" href="/assets/js/43.f3ab36d0.js"><link rel="prefetch" href="/assets/js/44.d72fbc07.js"><link rel="prefetch" href="/assets/js/45.a2c94371.js"><link rel="prefetch" href="/assets/js/46.e22c3a4d.js"><link rel="prefetch" href="/assets/js/47.699bd039.js"><link rel="prefetch" href="/assets/js/48.643e09ec.js"><link rel="prefetch" href="/assets/js/49.5593dccf.js"><link rel="prefetch" href="/assets/js/5.aa717142.js"><link rel="prefetch" href="/assets/js/50.bfb98f44.js"><link rel="prefetch" href="/assets/js/51.bb668b1f.js"><link rel="prefetch" href="/assets/js/52.a1e166b8.js"><link rel="prefetch" href="/assets/js/53.d9d4ab66.js"><link rel="prefetch" href="/assets/js/54.365f1440.js"><link rel="prefetch" href="/assets/js/55.aa7a99bc.js"><link rel="prefetch" href="/assets/js/56.f71d3bdc.js"><link rel="prefetch" href="/assets/js/57.c22489ff.js"><link rel="prefetch" href="/assets/js/58.961cb551.js"><link rel="prefetch" href="/assets/js/59.625c571b.js"><link rel="prefetch" href="/assets/js/6.2c0dbfe9.js"><link rel="prefetch" href="/assets/js/60.7cad7d61.js"><link rel="prefetch" href="/assets/js/61.3ab2039b.js"><link rel="prefetch" href="/assets/js/62.ebbcc7a8.js"><link rel="prefetch" href="/assets/js/63.022f6fe1.js"><link rel="prefetch" href="/assets/js/64.cfc0dcb3.js"><link rel="prefetch" href="/assets/js/65.4f892233.js"><link rel="prefetch" href="/assets/js/66.6e6574c2.js"><link rel="prefetch" href="/assets/js/67.40fb186e.js"><link rel="prefetch" href="/assets/js/68.54858ca7.js"><link rel="prefetch" href="/assets/js/69.e028e80f.js"><link rel="prefetch" href="/assets/js/7.3d66d209.js"><link rel="prefetch" href="/assets/js/70.9c1a0d51.js"><link rel="prefetch" href="/assets/js/71.9e6467f5.js"><link rel="prefetch" href="/assets/js/72.60bfce27.js"><link rel="prefetch" href="/assets/js/73.9ec43056.js"><link rel="prefetch" href="/assets/js/74.0aa6072f.js"><link rel="prefetch" href="/assets/js/75.865d7dda.js"><link rel="prefetch" href="/assets/js/76.fc1f0140.js"><link rel="prefetch" href="/assets/js/77.51e20bb9.js"><link rel="prefetch" href="/assets/js/78.93dbf54e.js"><link rel="prefetch" href="/assets/js/79.7a5b89c7.js"><link rel="prefetch" href="/assets/js/8.5b98a3a4.js"><link rel="prefetch" href="/assets/js/80.d2e23095.js"><link rel="prefetch" href="/assets/js/81.8b16c2f7.js"><link rel="prefetch" href="/assets/js/82.db077248.js"><link rel="prefetch" href="/assets/js/83.360d0cb4.js"><link rel="prefetch" href="/assets/js/84.50dadff3.js"><link rel="prefetch" href="/assets/js/85.0111e9a1.js"><link rel="prefetch" href="/assets/js/86.b2425a36.js"><link rel="prefetch" href="/assets/js/87.63aebc19.js"><link rel="prefetch" href="/assets/js/88.479041f7.js"><link rel="prefetch" href="/assets/js/89.769c409d.js"><link rel="prefetch" href="/assets/js/9.520db884.js"><link rel="prefetch" href="/assets/js/90.2ec7b507.js"><link rel="prefetch" href="/assets/js/91.9cae6dae.js"><link rel="prefetch" href="/assets/js/92.7863085a.js"><link rel="prefetch" href="/assets/js/93.3023daa8.js"><link rel="prefetch" href="/assets/js/94.7ffa85cb.js"><link rel="prefetch" href="/assets/js/95.b8b1e5dc.js"><link rel="prefetch" href="/assets/js/96.79ba50a3.js"><link rel="prefetch" href="/assets/js/97.988cb9bc.js"><link rel="prefetch" href="/assets/js/98.95938b5a.js"><link rel="prefetch" href="/assets/js/99.4842d35c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.16105da8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bing</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">归档</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clang/content.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/PHP/content.html" class="nav-link">PHP</a></li><li class="dropdown-item"><!----> <a href="/GO/content.html" class="nav-link">GO</a></li><li class="dropdown-item"><!----> <a href="/network/content.html" class="nav-link">网络</a></li><li class="dropdown-item"><!----> <a href="/datastructure/content.html" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/algorithms/content.html" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/Database/content.html" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">专栏</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topics/redis/content.html" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/topics/centent.html" class="nav-link">更多...</a></li></ul></div></div><div class="nav-item"><a href="/gossip/content.html" class="nav-link">杂谈</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/PHP/content.html" class="sidebar-link">PHP</a></li><li><a href="/PHP/basic.html" class="sidebar-link">PHP基础知识</a></li><li><a href="/PHP/tips.html" class="sidebar-link">PHP编程技巧与优化</a></li><li><a href="/PHP/sugs.html" class="sidebar-link">PHP 安全编程建议</a></li><li><a href="/PHP/static.html" class="sidebar-link">Static</a></li><li><a href="/PHP/router.html" class="sidebar-link">PHP路由技术的原理与实践</a></li><li><a href="/PHP/composer.html" class="sidebar-link">Composer</a></li><li><a href="/PHP/OOP/SRP.html" class="sidebar-link">单一职责原则SRP</a></li><li><a href="/PHP/OOP/OCP.html" class="sidebar-link">开闭原则OCP</a></li><li><a href="/PHP/OOP/LSP.html" class="sidebar-link">里氏替换原则LSP</a></li><li><a href="/PHP/OOP/ISP.html" class="sidebar-link">接口隔离原则ISP</a></li><li><a href="/PHP/OOP/DIP.html" class="sidebar-link">依赖倒置原则DIP</a></li><li><a href="/PHP/OOP/abstract_class.html" class="sidebar-link">抽象类</a></li><li><a href="/PHP/Laravel/Container.html" class="sidebar-link">Laravel 源码阅读 －容器</a></li><li><a href="/PHP/pattern/singleton.html" class="sidebar-link">单例模式</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="_9-1-php中的资源类型"><a href="#_9-1-php中的资源类型" aria-hidden="true" class="header-anchor">#</a> 9.1 PHP中的资源类型</h1> <p>讲述之前，先描述下{资源}类型在内核中的结构：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//每一个资源都是通过它来实现的。</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> _zend_rsrc_list_entry
<span class="token punctuation">{</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> type<span class="token punctuation">;</span>
	<span class="token keyword">int</span> refcount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>zend_rsrc_list_entry<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在真实世界中，我们经常需要操作一些不好用标量值表现的数据，比如某个文件的句柄，而对于C来说，它也仅仅是个指针而已。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FILE <span class="token operator">*</span>fd<span class="token punctuation">;</span>
	fd <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;/home/jdoe/.plan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>C语言中stdio的文件描述符(file descriptor)是与每个打开的文件相匹配的一个变量，它实际上是一个FILE类型的指针，它将在程序与硬件交互通讯时使用。我们可以使用fopen函数来打开一个文件获取句柄，之后只需把这个句柄传递给<code>feof()</code>、<code>fread()</code>、<code>fwrite()</code>、<code>fclose()</code>之类的函数，便可以对这个文件进行后续操作了。既然这个数据在C语言中就无法直接用标量数据来表示，那我们如何对其进行封装才能保证用户在PHP语言中也能使用到它呢？这便是PHP中资源类型变量的作用了！所以它也是通过一个zval结构来进行封装的。
资源类型的实现并不复杂，它的值其实仅仅是一个整数，内核将根据这个整数值去一个类似资源池的地方寻找最终需要的数据。</p> <h3 id="资源类型变量的使用"><a href="#资源类型变量的使用" aria-hidden="true" class="header-anchor">#</a> 资源类型变量的使用</h3> <p>资源类型的变量在实现中也是有类型区分的！为了区分不同类型的资源，比如一个是文件句柄，一个是mysql链接，我们需要为其赋予不同的分类名称。首先，我们需要先把这个分类添加到程序中去。这一步的操作可以在MINIT中来做：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> PHP_SAMPLE_DESCRIPTOR_RES_NAME &quot;山寨文件描述符&quot;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> le_sample_descriptor<span class="token punctuation">;</span>
<span class="token function">ZEND_MINIT_FUNCTION</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	le_sample_descriptor <span class="token operator">=</span> <span class="token function">zend_register_list_destructors_ex</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> PHP_SAMPLE_DESCRIPTOR_RES_NAME<span class="token punctuation">,</span>module_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//附加资料</span>
<span class="token macro property">#<span class="token directive keyword">define</span> register_list_destructors(ld, pld) zend_register_list_destructors((void (*)(void *))ld, (void (*)(void *))pld, module_number);</span>
ZEND_API <span class="token keyword">int</span> <span class="token function">zend_register_list_destructors</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ld<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pld<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> module_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
ZEND_API <span class="token keyword">int</span> <span class="token function">zend_register_list_destructors_ex</span><span class="token punctuation">(</span>rsrc_dtor_func_t ld<span class="token punctuation">,</span> rsrc_dtor_func_t pld<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>type_name<span class="token punctuation">,</span> <span class="token keyword">int</span> module_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>接下来，我们把定义好的MINIT阶段的函数添加到扩展的module_entry里去，只需要把原来的&quot;NULL, /* MINIT */&quot;一行替换掉即可：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_MINIT</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* MINIT */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>ZEND_MINIT_FUNCTION()</code>宏用来帮助我们定义MINIT阶段的函数，这我们已经在第一章里描述过了，但将会在第12章和第三章有更详细的描述。
What's important to know at this juncture is that the MINIT method is executed once when your extension is first loaded and before any requests have been received. Here you've used that opportunity to register destructor functionsthe NULL values, which you'll change soon enoughfor a resource type that will be thereafter known by a unique integer ID.
看到zend_register_list_destructors_ex()函数，你肯定会想是不是也存在一个<code>zend_register_list_destructors()</code>函数呢？是的，确实有这么一个函数，它的参数中比前者少了资源类别的名称。那这两这的区别在哪呢？</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>eaco <span class="token variable">$re_1</span><span class="token punctuation">;</span>
<span class="token comment">//resource(4) of type (山寨版File句柄)</span>

<span class="token keyword">echo</span> <span class="token variable">$re_2</span><span class="token punctuation">;</span>
<span class="token comment">//resource(4) of type (Unknown)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="创建资源"><a href="#创建资源" aria-hidden="true" class="header-anchor">#</a> 创建资源</h3> <p>我们在上面向内核中注册了一种新的资源类型，下一步便可以创建这种类型的资源变量了。接下来让我们简单的重新实现一个fopen函数，现在叫sample_open：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>sample_fopen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token operator">*</span>mode<span class="token punctuation">;</span>
	<span class="token keyword">int</span> filename_len<span class="token punctuation">,</span> mode_len<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span><span class="token function">ZEND_NUM_ARGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TSRMLS_CC<span class="token punctuation">,</span> <span class="token string">&quot;ss&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>filename_len<span class="token punctuation">,</span><span class="token operator">&amp;</span>mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mode_len<span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token function">RETURN_NULL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename_len <span class="token operator">||</span> <span class="token operator">!</span>mode_len<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span> TSRMLS_CC<span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span><span class="token string">&quot;Invalid filename or mode length&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span> TSRMLS_CC<span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span><span class="token string">&quot;Unable to open %s using mode %s&quot;</span><span class="token punctuation">,</span>filename<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
			RETURN_FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将fp添加到资源池中去，并标记它为le_sample_descriptor类型的。</span>
	<span class="token function">ZEND_REGISTER_RESOURCE</span><span class="token punctuation">(</span>return_value<span class="token punctuation">,</span>fp<span class="token punctuation">,</span>le_sample_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如果前面章节的知识你都看过的话，应该可以猜出最后一行代码是干啥的了。它创建了一个新的<code>le_sample_descriptor</code>类型的资源，此资源的值是fp，另外它把这个资源加入到一个存储资源的HashTable中，并把此资源在其中对应的数字Key赋给return_value。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>资源并不局限于文件句柄，我们可以申请一块内存，并且指向它的指针来作为一种资源。所以资源可以对应任意类型的数据。</p></div> <h3 id="销毁资源"><a href="#销毁资源" aria-hidden="true" class="header-anchor">#</a> 销毁资源</h3> <p>世间万物皆有喜有悲，有生有灭，到了我们探讨如何销毁资源的时候了。最简单的一种莫过于仿照<code>fclose</code>写一个sample_close()函数，在它里面实现对某种{资源：专指PHP的资源类型变量代表的值}的释放。</p> <p>但是，如果用户端的脚本通过<code>unset()</code>函数来释放某个资源类型的变量会如何呢？它们可不知道它的值最终对应一个<code>FILE*</code>指针啊，所以也无法使用<code>fclose()</code>函数来释放它，这个<code>FILE*</code>句柄很有可能会一直存在于内存中，直到PHP程序挂掉，由OS来回收。但在一个平常的Web环境中，我们的服务器都会长时间运行的。</p> <p>难道就没有解决方案了吗？当然不是，谜底就在那个NULL参数里，就是我们在上面为了生成新的资源类型，调用的<code>zend_register_list_destructors_ex()</code>函数的第一个参数和第二个参数。这两个参数都各自代表一个回调参数。第一个回调函数会在脚本中的相应类型的资源变量被释放掉的时候触发，比如作用域结束了，或者被<code>unset()</code>掉了。</p> <p>第二个回调函数则是用在一个类似于长链接类型的资源上的，也就是这个资源创建后会一直存在于内存中，而不会在request结束后被释放掉。它将会在Web服务器进程终止时调用，相当于在MSHUTDOWN阶段被内核调用。有关persistent resources的事宜，我们将在下一节里详述。</p> <p>我们先来定义第一种回调函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">php_sample_descriptor_dtor</span><span class="token punctuation">(</span>zend_rsrc_list_entry <span class="token operator">*</span>rsrc TSRMLS_DC<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token punctuation">(</span>FILE<span class="token operator">*</span><span class="token punctuation">)</span>rsrc<span class="token operator">-&gt;</span>ptr<span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后用它替换掉z<code>end_register_list_destructors_ex()</code>函数的第一个参数NULL：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>le_sample_descriptor <span class="token operator">=</span> <span class="token function">zend_register_list_destructors_ex</span><span class="token punctuation">(</span>
        php_sample_descriptor_dtor<span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        PHP_SAMPLE_DESCRIPTOR_RES_NAME<span class="token punctuation">,</span>
        module_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在，如果脚本中得到了一个上述类型的资源变量，当它被unset的时候，或者因为作用域执行完被内核释放掉的时候都会被内核调用底层的php_sample_descriptor_dtor来预处理它。这样一来，貌似我们根本就不需要sample_close()函数了！</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">sample_fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/home/jdoe/notes.txt&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>unset($fp)</code>执行后，内核会自动的调用php_sample_descriptor_dtor函数来清理这个变量对应的一些数据。
当然，事情绝对没有这么简单，让我们先记住这个疑问，继续往下看。</p> <h3 id="decoding-resources"><a href="#decoding-resources" aria-hidden="true" class="header-anchor">#</a> Decoding Resources</h3> <p>我们把资源变量比作书签，可如果仅有书签的话绝对没有任何作用啊！我们需要通过书签找到相应的页才行。对于资源变量，我们必须能够通过它找到相应的最终数据才行！</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>sample_fwrite<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
	zval <span class="token operator">*</span>file_resource<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
	<span class="token keyword">int</span> data_len<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span><span class="token function">ZEND_NUM_ARGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TSRMLS_CC<span class="token punctuation">,</span> <span class="token string">&quot;rs&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>file_resource<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_len<span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">RETURN_NULL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/* Use the zval* to verify the resource type and
	 * retrieve its pointer from the lookup table */</span>
	<span class="token function">ZEND_FETCH_RESOURCE</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span>FILE<span class="token operator">*</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>file_resource<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>PHP_SAMPLE_DESCRIPTOR_RES_NAME<span class="token punctuation">,</span>le_sample_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* Write the data, and
	 * return the number of bytes which were
	 * successfully written to the file */</span>
	<span class="token function">RETURN_LONG</span><span class="token punctuation">(</span><span class="token function">fwrite</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> data_len<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>zend_parse_parameters()</code>函数中的<code>r</code>占位符代表着接收资源类型的变量，它的载体是一个<code>zval*</code>。然后让我们看一下ZEND_FETCH_RESOURCE()宏函数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> ZEND_FETCH_RESOURCE(rsrc, rsrc_type, passed_id,default_id, resource_type_name, resource_type)</span>
    rsrc <span class="token operator">=</span> <span class="token punctuation">(</span>rsrc_type<span class="token punctuation">)</span> <span class="token function">zend_fetch_resource</span><span class="token punctuation">(</span>passed_id TSRMLS_CC<span class="token punctuation">,</span>default_id<span class="token punctuation">,</span> resource_type_name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> resource_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ZEND_VERIFY_RESOURCE</span><span class="token punctuation">(</span>rsrc<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//在我们的例子中，它是这样的：</span>
fp <span class="token operator">=</span> <span class="token punctuation">(</span>FILE<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">zend_fetch_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file_descriptor TSRMLS_CC<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>PHP_SAMPLE_DESCRIPTOR_RES_NAME<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> le_sample_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    RETURN_FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>zend_fetch_resource()</code>是对<code>zend_hash_find()</code>的一层封装，它使用一个数字key去一个保存各种{资源}的HashTable中寻找最终需要的数据，找到之后，我们用<code>ZEND_VERIFY_RESOURCE()</code>宏函数校验一下这个数据。从上面的代码中我们可以看出，NULL、0是绝对不能作为一种资源的。</p> <p>上面的例子中，<code>zend_fetch_resource()</code>函数首先获取<code>le_sample_descriptor</code>代表的资源类型，如果资源不存在或者接收的zval不是一个资源类型的变量，它便会返回NULL，并抛出相应的错误信息。</p> <p>最后的<code>ZEND_VERIFY_RESOURCE()</code>宏函数如果检测到错误，便会自动返回，使我们可以从错误检测中脱离出来，更加专注于程序的主逻辑。现在我们已经获取到了相应的<code>FILE*</code>了，下面就用<code>fwrite()</code>向其中写入点数据吧！</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>To avoid having <code>zend_fetch_resource()</code> generate an error on failure, simply pass <code>NULL</code> for the <code>resource_type_name</code> parameter. Without a meaningful error message to display, <code>zend_fetch_resource()</code> will fail silently instead.</p></div> <p>我们也可以通过另一种方法来获取我们最终想要的数据。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">ZEND_FUNCTION</span><span class="token punctuation">(</span>sample_fwrite<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
    zval <span class="token operator">*</span>file_resource<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> data_len<span class="token punctuation">,</span> rsrc_type<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span><span class="token function">ZEND_NUM_ARGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TSRMLS_CC<span class="token punctuation">,</span> <span class="token string">&quot;rs&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>file_resource<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data_len<span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RETURN_NULL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fp <span class="token operator">=</span> <span class="token punctuation">(</span>FILE<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">zend_list_find</span><span class="token punctuation">(</span><span class="token function">Z_RESVAL_P</span><span class="token punctuation">(</span>file_resource<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>rsrc_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp <span class="token operator">||</span> rsrc_type <span class="token operator">!=</span> le_sample_descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">php_error_docref</span><span class="token punctuation">(</span><span class="token constant">NULL</span> TSRMLS_CC<span class="token punctuation">,</span> E_WARNING<span class="token punctuation">,</span><span class="token string">&quot;Invalid resource provided&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RETURN_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">RETURN_LONG</span><span class="token punctuation">(</span><span class="token function">fwrite</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> data_len<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以根据自己习惯来选择到底使用哪一种形式，不过推荐使用ZEND_FETCH_RESOURCE()宏函数。</p> <h3 id="forcing-destruction"><a href="#forcing-destruction" aria-hidden="true" class="header-anchor">#</a> Forcing Destruction</h3> <p>在上面我们还有个疑问没有解决，就是类似于我们上面实现的unset($fp)真的是万能的么？当然不是，看一下下面的代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">sample_fopen</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;/home/jdoe/world_domination.log&quot;</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$evil_log</span> <span class="token operator">=</span> <span class="token variable">$fp</span><span class="token punctuation">;</span>
  <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这次，$fp和$evil_log共用一个zval，虽然$fp被释放了，但是它的zval并不会被释放，因为$evil_log还在用着。也就是说，现在$evil_log代表的文件句柄仍然是可以写入的！所以为了避免这种错误，真的需要我们手动来close it！sample_close()函数是必须存在的！</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">PHP_FUNCTION</span><span class="token punctuation">(</span>sample_fclose<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
    zval <span class="token operator">*</span>file_resource<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span><span class="token function">ZEND_NUM_ARGS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> TSRMLS_CC<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>file_resource<span class="token punctuation">)</span> <span class="token operator">==</span> FAILURE <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">RETURN_NULL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* While it's not necessary to actually fetch the
     * FILE* resource, performing the fetch provides
     * an opportunity to verify that we are closing
     * the correct resource type. */</span>
    <span class="token function">ZEND_FETCH_RESOURCE</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> FILE<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_resource<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>PHP_SAMPLE_DESCRIPTOR_RES_NAME<span class="token punctuation">,</span> le_sample_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Force the resource into self-destruct mode */</span>
    <span class="token function">zend_hash_index_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">EG</span><span class="token punctuation">(</span>regular_list<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Z_RESVAL_P</span><span class="token punctuation">(</span>file_resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RETURN_TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这个删除操作也再次说明了资源数据是保存在HashTable中的。虽然我们可以通过<code>zend_hash_index_find()</code>或者<code>zend_hash_next_index_insert()</code>之类的函数操作这个储存资源的HashTable，但这绝不是一个好主意，因为在后续的版本中，PHP可能会修改有关这一部分的实现方式，到那时上述方法便不起作用了，所以为了更好的兼容性，请使用标准的宏函数或者api函数。
当我们在<code>EG(regular_list)</code>这个HashTable中删除数据的时候，回调用一个dtor函数，它根据资源变量的类别来调用相应的dtor函数实现，就是我们调用<code>zend_register_list_destructors_ex()</code>函数时的第一个参数。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>在很多地方，我们都会看到一个专门用来删除的<code>zend_list_delete()</code>宏函数，因为它考虑了资源数据自己的引用计数，所以我们将在后面的章节中介绍它。</p></div> <h2 id="links"><a href="#links" aria-hidden="true" class="header-anchor">#</a> links</h2> <ul><li>9 <a href="/PHP/phpbook/9.html">PHP中的资源类型</a></li> <li>9.2 <a href="/PHP/phpbook/9.2.html">Persistent Resources</a></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新: </span> <span class="time">7/9/2019, 11:46:35 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/180.b390c5bb.js" defer></script><script src="/assets/js/app.6b2c809f.js" defer></script>
  </body>
</html>
